<!DOCTYPE html>
<html>
  <head>
    <title>Mega.nz Video Player</title>
  </head>
  <body>
    <video id="videoPlayer" controls></video>

    <script>
      // URL variable with the Mega.nz URL
      const URL = "https://mega.nz/file/YzFw2QqI#w9db9aFP918x2fRGBEKCA-jJjf53Z0hpR95HuqIGTNs";

      // The script content goes here
      URL="https://mega.nz/file/YzFw2QqI#w9db9aFP918x2fRGBEKCA-jJjf53Z0hpR95HuqIGTNs"

      if (URL.match(/^https?:\/\/mega(\.co)?\.nz/)) {
        URL = URL;
      }

      if (!URL) {
        console.error("Usage: ${0##*/} url");
        exit(1);
      }

      const CURL = "curl -Y 1 -y 10";

      let missing = false;
      const requiredCommands = ["openssl"];
      for (const cmd of requiredCommands) {
        if (!which(cmd)) {
          missing = true;
          console.error("${0##*/}: ${cmd}: command not found");
        }
      }
      if (missing) {
        exit(1);
      }

      let id, key;
      if (URL.match(/\/file\/[^#]*#[^#]*/)) {
        id = URL.split("file/")[1].split("#")[0];
        key = URL.split("file/")[1].split("#")[1];
      } else {
        id = URL.split("!")[1];
        key = URL.split("!")[2];
      }

      const raw_hex = atob(key.replace(/-/g, "+").replace(/_/g, "/").replace(/,/g, "")).split("").map(c => c.charCodeAt(0).toString(16).padStart(2, "0")).join("");
      const hex = String.raw`0x${(parseInt(raw_hex.slice(0, 16), 16) ^ parseInt(raw_hex.slice(32, 48), 16)).toString(16).padStart(16, "0")}${(parseInt(raw_hex.slice(16, 32), 16) ^ parseInt(raw_hex.slice(48, 64), 16)).toString(16).padStart(16, "0")}`;

      const json = JSON.parse(runCommand(`${CURL} -s -H 'Content-Type: application/json' -d '[{"a":"g", "g":"1", "p":"${id}"}]' 'https://g.api.mega.co.nz/cs?id=&ak='`));
      const file_url = json[0].g;

      const at = JSON.parse(runCommand(`${CURL} -s -H 'Content-Type: application/json' -d '[{"a":"g", "p":"${id}"}]' 'https://g.api.mega.co.nz/cs?id=&ak='`)).at;

      const jsonDecoded = JSON.parse(decryptBase64UrlSafe(at, hex));

      let file_name = jsonDecoded.n;
      if (file_name.includes(",")) {
        file_name = file_name.split(",")[0];
      }

      console.log("Video URL:", file_url);
      console.log("File Name:", file_name);

      // Create a video element and set the source URL
      const videoPlayer = document.getElementById("videoPlayer");
      const source = document.createElement("source");
      source.src = file_url;
      source.type = "video/mp4";

      // Add the source to the video player
      videoPlayer.appendChild(source);

      // Set the video player controls and display the video
      videoPlayer.controls = true;

      // Alternative implementation of runCommand using fetch
      function runCommand(command) {
        return fetch("/run-command", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ command }),
        })
          .then(response => response.text())
          .then(output => {
            console.log("Running command:", command);
            console.log("Command output:", output);
            return output;
          })
          .catch(error => {
            console.error("Error running command:", command);
            console.error(error);
            return "";
          });
      }

      // Alternative implementation of decryptBase64UrlSafe using CryptoJS
function decryptBase64UrlSafe(at, hex) {
  const key = CryptoJS.enc.Hex.parse(hex);
  const iv = CryptoJS.enc.Hex.parse("00000000000000000000000000000000");
  const ciphertext = CryptoJS.enc.Base64.parse(at);
  const decrypted = CryptoJS.AES.decrypt({ ciphertext }, key, { iv });
  const decryptedText = decrypted.toString(CryptoJS.enc.Utf8);

  console.log("Decrypting:", at);
  console.log("Decrypted output:", decryptedText);
  return decryptedText;
}
